substitutions:
  number_of_steps: "6144"  # 2048 * 3

esphome:
  name: feeder-door
  friendly_name: Feeder Door Controller

esp8266:
  board: esp01_1m

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Feeder Door Controller"
    password: !secret wifi_ap_password

captive_portal:

web_server:
  port: 80

number:
  - platform: template
    name: "Template number"
    optimistic: true
    min_value: 0
    max_value: ${number_of_steps}
    step: 1
    on_value:
      then:
        - stepper.set_target:
            id: door_stepper
            target: !lambda "return x;"

button:
  - platform: template
    name: "Door Open Button"
    on_press:
      then:
        - logger.log: "Door Open Button Pressed"
        - lambda: |-
            while (!id(open_sensor).state) {
              ESP_LOGI("FeederDoor", "NOT OPEN");
              ESP_LOGE("FeederDoor", "MOVE OPEN");
              break;
            }
  - platform: template
    name: "Door Close Button"
    on_press:
      then:
        - logger.log: "Door Close Button Pressed"
        - lambda: |-
            while (!id(closed_sensor).state) {
              ESP_LOGI("FeederDoor", "NOT CLOSED");
              ESP_LOGE("FeederDoor", "MOVE CLOSE");
              break;
            }
  - platform: template
    name: "Door State Button"
    on_press:
      then:
        - logger.log: "Door State Button Pressed"
        - lambda: |-
            if (id(closed_sensor).state) {
              ESP_LOGI("FeederDoor", "Feeder Door is closed");
            } else {
              ESP_LOGI("FeederDoor", "Feeder Door is not closed");
            }
            if (id(open_sensor).state) {
              ESP_LOGI("FeederDoor", "Feeder Door is open");
            } else {
              ESP_LOGI("FeederDoor", "Feeder Door is not open");
            }

sensor:
  - platform: wifi_signal
    name: "Feeder Door WiFi Signal"
  - platform: template
    name: "Position Sensor"
    id: position

stepper:
  - platform: uln2003
    id: door_stepper
    pin_a: GPIO15  # D8
    pin_b: GPIO13  # D7
    pin_c: GPIO12  # D6
    pin_d: GPIO14  # D5
    sleep_when_done: true
    max_speed: 100 steps/s  # FIXME
    acceleration: inf
    deceleration: inf

binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO4  # D2
      mode: INPUT_PULLUP
    name: "Door Open Sensor"
    id: open_sensor
    filters:
      - invert:
  - platform: gpio
    pin: 
      number: GPIO5  # D1
      mode: INPUT_PULLUP
    name: "Door Closed Sensor"
    id: closed_sensor
    filters:
      - invert:

cover:
  - platform: template
    name: "Door"
    id: door
#    device_class: None
    open_action:
      - stepper.set_target:
          id: door_stepper
          target: ${number_of_steps}
      - sensor.template.publish:
          id: position
          state: !lambda return id(door_stepper).target_position;
    close_action:
      - stepper.set_target:
          id: door_stepper
          target: 0
      - sensor.template.publish:
          id: position
          state: !lambda return id(door_stepper).target_position;
    stop_action:
      - stepper.set_target:
          id: door_stepper
          target: !lambda return id(door_stepper).current_position;
      - sensor.template.publish:
          id: position
          state: !lambda return id(door_stepper).current_position;
    optimistic: True
    assumed_state: True
