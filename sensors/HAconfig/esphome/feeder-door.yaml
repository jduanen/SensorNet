substitutions:
  max_number_of_steps: "2440"  # hand-tuned
  max_time: "10s"              # hand-tuned  #### FIXME
  max_speed: "400 steps/s"     # hand-tuned
  friendly_name: "Feeder Door Controller"

esphome:
  name: feeder-door
  friendly_name: ${friendly_name}
  comment: "Cat Feeding Machine Door Open/Close Controller"
  on_boot:
    priority: 600  # after HW, but before WiFi
    then:
      - script.execute: home_on_startup

esp8266:
  board: esp01_1m

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: ${friendly_name}
    password: !secret wifi_ap_password

captive_portal:

web_server:
  port: 80

number:
  - platform: template
    name: "Door Position"
    optimistic: true
    min_value: 0
    max_value: ${number_of_steps}
    step: 1
    on_value:
      then:
        - stepper.set_target:
            id: door_stepper
            target: !lambda "return x;"

sensor:
  - platform: wifi_signal
    id: wifi_rssi
    name: "${friendly_name} WiFi Signal"
  - platform: template
    name: "Position Sensor"
    id: position

stepper:
  - platform: uln2003
    id: door_stepper
    pin_d: GPIO15  # D8
    pin_c: GPIO13  # D7
    pin_b: GPIO12  # D6
    pin_a: GPIO14  # D5
    sleep_when_done: true
    max_speed: ${max_speed}
    acceleration: inf
    deceleration: inf

binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO4  # D2
      mode: INPUT_PULLUP
    name: "Door Open Switch"
    id: door_open_switch
    filters:
      - invert:
  - platform: gpio
    pin: 
      number: GPIO5  # D1
      mode: INPUT_PULLUP
    name: "Door Close Switch"
    id: door_close_switch
    filters:
      - invert:

script:
  - id: home_on_startup
    then:
      - logger.log: "Start homing"
      - while:
          condition:
            binary_sensor.is_off: door_close_switch
          then:
            - stepper.set_target:
              id: door_stepper
              target: !lambda 'return id(door_stepper).current_position - 10;'
            - delay: 100ms
      - stepper.report_position:
          id: door_stepper
          position: 0
      - logger.log: "End homing"

#### TODO put in max steps test to keep it from going on indefinitely
cover:
  - platform: template
    name: "Feeder Door"
    id: feeder_door
    lambda: |-
      if (id(door_close_switch).state) return COVER_CLOSED;
      if (id(door_open_switch).state) return COVER_OPEN;
      return COVER_OPENING;  // or CLOSING depending on logic
    open_action:
      - stepper.set_target:
          id: door_stepper
          target: !lambda 'return max_number_of_steps;'
      - wait_until:
          condition:
            binary_sensor.is_on: door_open_switch
          timeout: max_time
      - stepper.stop: door_stepper
      - stepper.report_position:
          id: door_stepper
          position: max_number_of_steps
    close_action:
      - stepper.set_target:
          id: door_stepper
          target: 0
      - wait_until:
          condition:
            binary_sensor.is_on: door_close_switch
          timeout: max_time
      - stepper.stop: door_stepper
      - stepper.report_position:
          id: door_stepper
          position: 0
    stop_action:
      - stepper.stop: door_stepper
    on_open:
      - logger.log: "Feeder door is open"
    on_closed:
      - logger.log: "Feeder door is closed"
