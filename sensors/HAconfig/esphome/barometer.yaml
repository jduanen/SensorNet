substitutions:
  name_str: "Barometer DWR"
  upper_devicename: "BAROMETER_DWR"

esphome:
  name: barometer_dwr
  friendly_name: Barometer_DWR

esp32:
  board: seeed_xiao_esp32c3
  framework:
    type: arduino

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Barometer"
    password: !secret wifi_ap_password

captive_portal:

web_server:
  port: 80

globals:
  - id: current_page
    type: int
    restore_value: false
    initial_value: '0'

i2c:
  sda: GPIO6  # D4
  scl: GPIO7  # D5
  scan: true

time:
  - platform: homeassistant
    id: esptime
                         
font:
  - file: "gfonts://Roboto"
    id: roboto
    size: 14
  - file: "gfonts://Roboto"
    id: roboto_mid
    size: 24
  - file: "gfonts://Roboto"
    id: roboto_big
    size: 32
  - file: "gfonts://Roboto"
    id: menu_font
    size: 12
  - file: "fonts/RobotoSlab-Regular.ttf"
    id: roboto_label
    size: 14

text_sensor:
  - platform: homeassistant
    entity_id: ota.status
    name: "OTA Status"
  - platform: version
    id: firmware_version
    name: "Firmware Version"
  - platform: wifi_info
    ip_address:
      id: ipAddr
      name: ESP IP Address
    ssid:
      name: ESP Connected SSID
    bssid:
      name: ESP Connected BSSID
    mac_address:
      id: macAddr
      name: ESP Mac Wifi Address
    scan_results:
      name: ESP Latest Scan Results
    dns_address:
      name: ESP DNS Address

binary_sensor:
  - platform: gpio
    id: encoder_button
    name: "Rotary Encoder Button"
    pin:
      number: GPIO2  # D0
      inverted: True
      #allow_other_uses: True  #This is needed to share pin betwen functions: https://esphome.io/guides/configuration-types#config-pin-schema
      mode:
        input: True
        pullup: True
    filters:
      - delayed_on: 10ms
      - delayed_off: 10ms
    on_press:
      - logger.log: "Rotary Encoder Button Pressed!"
      - if:
          condition:
              display_menu.is_active: oled_menu
          then:
            - display_menu.enter: oled_menu
          else:
            - display_menu.show:  oled_menu

sensor:
  - platform: wifi_signal
    id: wifi_rssi
    name: "Barometer WiFi Signal"
    update_interval: 60s
  - platform: dps310
    temperature:
      name: "Temperature"
      id: temp
      unit_of_measurement: °C
      accuracy_decimals: 2
    pressure:
      name: "Pressure"
      id: press
      unit_of_measurement: hPa
      accuracy_decimals: 3
    address: 0x77
    update_interval: 15s  # 60s
  - platform: rotary_encoder
    id: menu_encoder
    name: "Page Navigator"
    filters:
      - debounce: 30ms
    pin_a:
      number: GPIO3  # D1
      mode:
        input: true
        pullup: true
    pin_b:
      number: GPIO4  # D2
      mode:
        input: true
        pullup: true
    resolution: 1  # 4 # higher resolution for smoother detection
    min_value: 0
    max_value: 3   # 4 menu items (0-3)
    on_clockwise:
      - logger.log: "Turned Clockwise"
      - display_menu.up: oled_menu
    on_anticlockwise:
      - logger.log: "Turned Counter-clockwise"
      - display_menu.down: oled_menu

graphical_display_menu:
  display: oled_display
  id: oled_menu
  active: false
  font: menu_font
  mode: rotary
  items:
    - type: command
      text: "Current State"
      on_value:
        - lambda: |-
            id(current_page) = 0;
        - display_menu.hide: oled_menu
    - type: command
      text: "Altitude Info"
      on_value:
        - lambda: |-
            id(current_page) = 1;
        - display_menu.hide: oled_menu
    - type: command
      text: "Settings"
      on_value:
        - lambda: |-
            id(current_page) = 2;
        - display_menu.hide: oled_menu
    - type: command
      text: "Close Menu"
      on_value:
        - display_menu.hide: oled_menu

display:
  - platform: ssd1306_i2c
    model: "SH1106 128x64"
    address: 0x3C
    id: oled_display
    lambda: |-
      if (id(oled_menu).is_active()) {
        it.menu(0, 0, id(oled_menu), it.get_width(), it.get_height());
      } else {
        if (id(current_page) == 0) {
          it.printf(0, 0, id(roboto), "Press: %.3fhPa", id(press).state);
          it.printf(0, 16, id(roboto), "Temp: %.2f°C", id(temp).state);
          it.printf(0, 32, id(roboto), "Altitude: %.1fm", 1234.5);
          it.printf(0, 48, id(roboto), "%s", "MM:DD:YY HH:MM:SS");
        } else if (id(current_page) == 1) {
          it.printf(0, 0, id(roboto), "ALTITUDE");
        } else if (id(current_page) == 2) {
          it.printf(0, 0, id(roboto), "SETTINGS");
        } else if (id(current_page) == 3) {
          if (id(oled_menu).is_active())
            it.menu(0, 0, id(oled_menu), it.get_width(), it.get_height());
        }
      }


# calculate altitude changes that correspond to specific pressure changes at a given temperature
#
#  R = 287 J/kg (specific gas constant for air)
#  T = temperature (Kelvin)
#  P = reference pressure (e.g., 1013.25 hPa at the base level -- e.g., sea level)
#  g = 9.81 m/s^2
#  T_0 = 288K (reference temperature in Kelvin at the base level)
#  L = 0.0065 K/m (temperature lapse rate -- 6.5C per 1000meters)
#  P_0 = 1013.25 hPa
#  dP = change in pressure
#  r(t) = air density as a function of temperature (decreases with increasing temperature)
#
# hydrostatic equation
#  height = ((dP * R * T) / (P * g))
#
# approximation (sea level, 15C (288K), dry air): 1hPa ~ 8m of air column
#  1hPA equivalent height: -10C ~ 7.5m, 15C ~ 8.0m, 30C ~ 8.5m
#
#  r(T) = (P / (R * T))
#  h(T) = (dP / (r(T) * g)) = (dP / ((P / (R * T)) * g))
#   assume 30C:
#    r(30C) = ((1013.25 * 100) / (287 * 303)) ~ 1.165 kg/m^3
#    1hPa = (100Pa / (1.165 * 9.81)) ~ 8.75m
#
# barometric formula:
#  height = ((T_0 / L) * (1 - (P / P_0)^((R * L) / 9))) meters
#
#  30C, T_0=288K, L = 0.0065K/m, P_0 = 1013.25hPa, R = 287 J/kg
#    h = ((288 / 0.0065) * (1 - (P / 1013.25)^((287 * 0.0065) / 9))
#    h(P, P_0) = 51428.571429 * (1 - (P / P_0)^0.207278)
#
# def h(p, p0):
#   return (51428.571429 * (1 - (p/p0)**0.207278))

